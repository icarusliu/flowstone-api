<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="init-user" author="test">
        <sql>
            create table base_user(
            id varchar(64) not null primary key,
            username varchar(64),
            password varchar(255),
            phone varchar(32),
            email varchar(64),
            status int(1) default 1,
            photo varchar(255),
            metadata text,
            ext1 varchar(255),
            ext2 varchar(255),
            ext3 varchar(255),
            is_super_admin int(1) default 0,
            tenant_id varchar(32),
            create_user varchar(64),
            create_time timestamp default current_timestamp,
            update_user varchar(64),
            update_time timestamp default current_timestamp on update current_timestamp,
            deleted int(1) default 0
            );
        </sql>
    </changeSet>

    <changeSet id="init-admin-user" author="test" failOnError="false">
        <sql>
            alter table base_user add column nickname varchar(64) comment '姓名';
            insert into base_user(id, username, password, phone, is_super_admin, tenant_id, nickname)
            values('QIQINIUBI', 'admin', '$2a$10$/eAkf76RWkJEDO3SR1dEnO7QRgpLn3dViFpT2GY/hvxU.CBVc/ue.', '13973111891', 1, 'sys', 'admin');
        </sql>
    </changeSet>

    <changeSet id="init-role" author="test">
        <sql>
            create table base_role(
            id varchar(64) not null primary key,
            code varchar(64) not null,
            name varchar(255) not null,
            tenant_id varchar(32),
            create_user varchar(64),
            create_time timestamp default current_timestamp,
            update_user varchar(64),
            update_time timestamp default current_timestamp on update current_timestamp,
            deleted int(1) default 0
            );
        </sql>
    </changeSet>

    <changeSet id="init-user-role" author="test">
        <sql>
            create table base_user_role(
            id varchar(64) not null primary key,
            user_id varchar(64) not null comment '用户id',
            role_id varchar(64) not null comment '角色id',
            tenant_id varchar(32),
            create_user varchar(64),
            create_time timestamp default current_timestamp,
            update_user varchar(64),
            update_time timestamp default current_timestamp on update current_timestamp,
            deleted int(1) default 0
            );
        </sql>
    </changeSet>


    <changeSet id="init-dept-user" author="test">
        <sql>
            create table base_dept_user(
            id varchar(64) not null primary key,
            user_id varchar(64) not null comment '用户id',
            dept_id varchar(64) not null comment '机构id',
            tenant_id varchar(32),
            create_user varchar(64),
            create_time timestamp default current_timestamp,
            update_user varchar(64),
            update_time timestamp default current_timestamp on update current_timestamp,
            deleted int(1) default 0
            );
        </sql>
    </changeSet>

    <changeSet id="create-table-base_menu" author="codeGenerator">
        <sql>
            create table base_menu(
            id varchar(64) not null primary key comment '主键',
            code varchar(255),
            name varchar(255),
            path varchar(255),
            type varchar(255),
            hide int(1) default 0,
            parent_id varchar(255),
            sort integer,
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_api" author="codeGenerator">
        <sql>
            create table d_api(
            id varchar(64) not null primary key comment '主键',
            type_id varchar(64) not null comment '分类id',
            `content` text not null comment '接口配置',
            name varchar(255) not null comment '接口名称',
            remark varchar(255) comment '接口备注',
            path varchar(255) not null comment '接口路径',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_api_draft" author="codeGenerator">
        <sql>
            create table d_api_draft(
            id varchar(64) not null primary key comment '主键',
            type_id varchar(64) not null comment '分类id',
            `content` text not null comment '接口配置',
            name varchar(255) not null comment '接口名称',
            remark varchar(255) comment '接口备注',
            path varchar(255) not null comment '接口路径',
            status int not null default 0 comment '发布状态，0：未发布； 1：已发布; 2：已修改未发布； 3：已下线',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_ds" author="codeGenerator">
        <sql>
            create table d_ds(
            id varchar(64) not null primary key comment '主键',
            code varchar(64) not null comment '数据源编码',
            name varchar(128) not null comment '数据源名称',
            type varchar(32) not null default 'mysql' comment '数据源类型',
            url varchar(255) not null comment '数据源地址',
            username varchar(64) not null comment '用户名',
            password varchar(64) not null comment '密码',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_api_type" author="codeGenerator">
        <sql>
            create table d_api_type(
            id varchar(64) not null primary key comment '主键',
            name varchar(255) not null comment '名称',
            sort integer default 0 comment '排序',
            parent_id varchar(255),
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_api_supplier" author="codeGenerator">
        <sql>
            create table d_api_supplier(
            id varchar(64) not null primary key comment '主键',
            name varchar(255) not null comment '名称',
            url varchar(255) not null comment '路径',
            remark varchar(255) comment '备注',
            auth_config text comment '鉴权配置',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-d_api_log" author="codeGenerator">
        <sql>
            create table d_api_log(
            id varchar(64) not null primary key comment '主键',
            api_id varchar(64) not null,
            api_path varchar(128) not null,
            api_name varchar(255) not null,
            status integer default 0 comment '状态',
            params varchar(1000) comment '接口调用参数',
            error_msg varchar(1000) comment '简短异常信息',
            result text comment '存储结果或异常详细信息',
            spent_time int default 0 comment '耗时',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>

    <changeSet id="add-method" author="liuqi">
        <sql>
            alter table d_api add column method varchar(64) default 'get' comment '方法';
            alter table d_api_draft add column method varchar(64) default 'get' comment '方法';
        </sql>
    </changeSet>
    <changeSet id="create-table-base_schedule_task" author="codeGenerator">
        <sql>
            create table base_schedule_task(
            id varchar(64) not null primary key comment '主键',
            name varchar(255) not null comment '任务名称',
            cron varchar(512) not null comment '任务执行配置',
            api_id varchar(64) not null comment '调用接口',
            api_name varchar(255) comment '接口名称',
            remark varchar(255) comment '备注',
            params varchar(1024) comment '任务调用参数',
            status integer not null default 1 comment '任务状态，0: 停用；1：启用',
            started int(1) not null default 0 comment '是否启动',
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>
    <changeSet id="create-table-base_sys_config" author="codeGenerator">
        <sql>
            create table base_sys_config(
            id varchar(64) not null primary key comment '主键',
            code varchar(255),
            value varchar(255),
            name varchar(255),
            remark varchar(255),
            enabled int(1) default 0,
            tenant_id varchar(255) comment '租户编号',
            create_user varchar(255) comment '创建用户',
            create_time timestamp default current_timestamp comment '创建时间',
            update_user varchar(255) comment '更新用户',
            update_time timestamp on update current_timestamp comment '更新时间',
            deleted int(1) default 0 comment '是否删除'
            )
        </sql>
    </changeSet>

    <changeSet id="init-test-data" author="qi2.liu">
        <sql>
            <![CDATA[
                INSERT INTO d_api_supplier (id, name, url, remark, auth_config, tenant_id, create_user, create_time, update_user, update_time, deleted) VALUES ('1822951519482310658', 'local', 'http://localhost:8080', null, '[]', null, null, '2024-08-12 19:01:25', 'admin', '2024-09-24 10:46:05', 0);
                INSERT INTO d_api_draft (id, type_id, content, name, remark, path, status, tenant_id, create_user, create_time, update_user, update_time, deleted, method) VALUES ('1838396512896405506', '1822093887141924865', '{"nodes":[{"id":"7c018431-2979-4552-b307-d159bbbbc5eb","code":"node1","name":"新建测试表","icon":"icon-jiediansql","type":"sql","left":53,"top":78,"parentIds":[],"config":{"params":[],"ds":"local","sql":"create table if not exists t_test(id varchar(32), name varchar(32))"}},{"id":"7fce5e99-c0db-42c1-82cb-57dd6904d408","code":"node2","name":"插入测试","icon":"icon-jiediansql","type":"sql","left":260,"top":92,"parentIds":["7c018431-2979-4552-b307-d159bbbbc5eb"],"config":{"params":[{"type":"request","id":"af586e8b-5aaf-4814-afdd-6e9b8a894634","key":"id","value":"id"},{"type":"request","id":"9a893735-9fdc-410a-9809-a96dd3ea9359","key":"name","value":"name"}],"ds":"local","sql":"insert into t_test(id, name)\\r\\nvalues(#{id}, #{name})"}},{"id":"5a1b64d5-2f5f-4016-a9d7-e408c07d2a92","code":"node3","name":"查询测试","icon":"icon-jiediansql","type":"sql","left":492,"top":104,"parentIds":["7fce5e99-c0db-42c1-82cb-57dd6904d408"],"config":{"params":[{"type":"request","id":"a1fd6d80-defe-4fcf-a17c-2ed4d6bfd289","key":"id","value":"id"}],"ds":"local","sql":"select * from t_test\\r\\nwhere 1 = 1\\r\\n<if test=\\"null != id and \'\' != id\\">\\r\\nand id = #{id}\\r\\n</if>"}}],"testData":{"queryParams":[{"id":"b3eb50e2-9ef0-4f44-948e-b6f301626948","code":"id","value":"test"},{"id":"845f406d-4819-4e64-a885-0b38f00f8bd8","code":"name","value":"test"}]},"inputParams":[],"output":[],"queryParams":[]}', '建表、插入、查询测试', null, 'test/sql', 2, 'sys', 'admin', '2024-09-24 09:54:19', 'admin', '2024-09-24 10:40:32', 0, 'get');
                INSERT INTO d_api_type (id, name, sort, parent_id, tenant_id, create_user, create_time, update_user, update_time, deleted) VALUES ('1822093887141924865', '接口测试', 0, null, null, null, '2024-08-10 10:13:30', null, '2024-08-13 14:26:45', 0);
                INSERT INTO d_ds (id, code, name, type, url, username, password, tenant_id, create_user, create_time, update_user, update_time, deleted) VALUES ('1822106626417602561', 'local', '本地数据库', 'mysql', 'jdbc:mysql://localhost:3306/acode_api?useUnicode=true&characterEncoding=utf8&useSSL=false&zeroDateTimeBehavior=convertToNull', 'root', 'mysql12345', null, null, '2024-08-10 11:04:07', null, null, 0);
            ]]>
        </sql>
    </changeSet>
</databaseChangeLog>
